{% extends 'base.html' %}
{% load consulta_tags %}
{% load static %}

{% block title %}Meus Agendamentos{% endblock %}

{% block css %}
    <link rel="stylesheet" href="{% static 'css/public/dashboard_shared.css' %}">
    <style>
        .agenda-container { max-width: 900px; margin: 2rem auto; }
        .agenda-list-wrapper {
            background-color: #fff; border-radius: 12px; padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); margin-top: 1.5rem;
        }
        .consulta-grid {
            display: grid; grid-template-columns: 1.5fr 2.5fr 1fr 1fr; /* Data, Psicólogo, Status, Ações */
            gap: 0.5rem 1rem; align-items: center; padding: 1rem 0; border-bottom: 1px solid #eee;
        }
        .agenda-list-wrapper .consulta-grid:last-of-type { border-bottom: none; padding-bottom: 0; }
        .consulta-header { font-weight: 600; color: #555; font-size: 0.9rem; padding-bottom: 1rem; border-bottom: 2px solid #ddd; margin-bottom: 0.5rem; }
        .consulta-grid span { font-size: 0.95rem; }
        .consulta-status-paciente { padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.8rem; text-align: center; font-weight: 500; justify-self: center; display: inline-block; }
        .status-confirmada { background-color: #d4edda; color: #155724; }
        .status-pendente { background-color: #fff3cd; color: #856404; }
        .status-realizada { background-color: #d1ecf1; color: #0c5460; }
        .status-cancelada { background-color: #f8d7da; color: #721c24; }
        .status-aguardando_remarcacao { background-color: #ffc107; color: #333; } /* Laranja/Amarelo */
        .consulta-actions a { color: #3498db; text-decoration: none; font-size: 0.9rem; }
        .consulta-actions a:hover { text-decoration: underline; }
        .consulta-actions { justify-self: center; display: flex;flex-direction: column; gap: 6px;align-items: center; }
        .pagination { display: flex; justify-content: center; margin-top: 2.5rem; padding-bottom: 1rem; }
        .pagination a, .pagination span { padding: 0.6rem 1.1rem; margin: 0 0.3rem; border: 1px solid #ddd; text-decoration: none; color: #3498db; border-radius: 6px; transition: all 0.2s ease; }
        .pagination a:hover { background-color: #f0f8ff; border-color: #aed9f5; }
        .pagination .current { background-color: #3498db; color: white; border-color: #3498db; font-weight: bold; }
        .pagination .disabled { color: #ccc; border-color: #eee; cursor: default; }
        .pagination .disabled:hover { background-color: transparent; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-secondary:hover { background-color: #5a6268; }
    </style>
{% endblock %}

{% block content %}
<div class="dashboard-container agenda-container">
    <div class="dashboard-header">
        <h1>Meus Agendamentos</h1>
    </div>

    <div class="agenda-list-wrapper">
        <div class="consulta-grid consulta-header">
            <span>Data / Hora</span>
            <span>Psicólogo(a)</span>
            <span>Status</span>
            <span>Ações</span>
        </div>

        {% for consulta in page_obj %}
            <div class="consulta-grid">
                <span>{{ consulta.data|date:"d/m/Y" }} - {{ consulta.hora|time:"H:i" }}</span>
                <span>Dr(a). {{ consulta.psicologo.usuario.nome }}</span>
                <span>
                     <span class="consulta-status-paciente status-{{ consulta.status }}">
                        {{ consulta.get_status_display }}
                    </span>
                </span>
                <span class="consulta-actions">
                    <a href="{% url 'paciente:consulta_detalhes' consulta.id_consulta %}" 
                    class="btn-action btn-detalhes" 
                    style="background-color: #6c757d; color: white;font-size: 0.8rem; border-radius: 4px; padding: 0.3rem 0.6rem; text-decoration: none;">
                    Ver Detalhes
                    </a>
                    
                    {% if consulta|can_reschedule %}
                        <a href="{% url 'paciente:solicitar_remarcacao' consulta.id_consulta %}" class="btn btn-secondary" style="font-size: 0.8rem; padding: 0.3rem 0.6rem; margin-left: 5px; background-color: #ffc107; color: #333;">Remarcar</a> 
                    {% endif %}
                    

                    {% if consulta.status == 'confirmada' %}
                        {% if not consulta.paciente_confirmou_presenca %}
                            <form method="POST" action="{% url 'paciente:confirmar_presenca' consulta.id_consulta %}" style="display: inline; margin-left: 5px;"> 
                                {% csrf_token %}
                                <button type="submit" class="btn btn-primary" style="font-size: 0.8rem; padding: 0.3rem 0.6rem; background: #28a745; color: #fff;border:none; border-radius: 4px;">Confirmar Presença</button>
                            </form>
                        {% else %}
                            <span style="text-align: center; font-size: 0.9rem; color: #155724; font-weight: bold; margin-left: 5px;">✓ Presença Confirmada</span>
                        {% endif %}
                    {% endif %}
                </span>
            </div>
        {% empty %}
            <p class="empty-list-text">Nenhuma consulta encontrada.</p> {# Usa a classe CSS #}
        {% endfor %}
    </div>

    <div class="pagination">
        <span class="step-links">
            {% if page_obj.has_previous %}
                <a href="?page=1">&laquo; Primeira</a>
                <a href="?page={{ page_obj.previous_page_number }}">Anterior</a>
            {% else %}
                <span class="disabled">&laquo; Primeira</span>
                <span class="disabled">Anterior</span>
            {% endif %}
            <span class="current">
                Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}.
            </span>
            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}">Próxima</a>
                <a href="?page={{ page_obj.paginator.num_pages }}">Última &raquo;</a>
            {% else %}
                <span class="disabled">Próxima</span>
                <span class="disabled">Última &raquo;</span>
            {% endif %}
        </span>
    </div>
</div>
{% endblock %}